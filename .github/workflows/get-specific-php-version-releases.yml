name: Get PHP Releases for each version
on:
  workflow_dispatch: {}
  schedule:
    - cron: '15 12 * * *'  # Daily at 12:15 UTC (15 min after main releases fetch)
  push:
    branches:
      - main
    paths:
      - php-releases/releases.json

concurrency:
  group: get-specific-php-releases
  cancel-in-progress: false

jobs:
  get-new-versions:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v6

      - name: Checkout Branch
        uses: paketo-buildpacks/github-config/actions/pull-request/checkout-branch@main
        with:
          branch: automation/php-releases/update

      - name: Get PHP Versions
        id: fetch
        run: |
          set -euo pipefail

          versions=($(jq -r 'keys | .[]' php-releases/releases.json))
          echo "ðŸ“¦ Found ${#versions[@]} PHP version lines: ${versions[*]}"

          for version in "${versions[@]}"; do
            echo "Fetching releases for PHP $version..."
            output_file="php-releases/php-$version.json"

            curl --silent --show-error --fail --http2 \
              "https://www.php.net/releases/index.php?json&version=$version&max=1000" \
              --output "$output_file"

          done

      - name: Check for Changes
        id: changes
        run: |
          if git diff --exit-code php-releases/php-*.json > /dev/null 2>&1; then
            echo "has-changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "has-changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit
        if: ${{ steps.changes.outputs.has-changes == 'true' }}
        id: commit
        uses: paketo-buildpacks/github-config/actions/pull-request/create-commit@main
        with:
          message: "Update PHP releases for each version"
          pathspec: "php-releases/php-*.json"
          keyid: ${{ secrets.PAKETO_BOT_GPG_SIGNING_KEY_ID }}
          key: ${{ secrets.PAKETO_BOT_GPG_SIGNING_KEY }}

      - name: Push Branch
        if: ${{ steps.commit.outputs.commit_sha != '' }}
        uses: paketo-buildpacks/github-config/actions/pull-request/push-branch@main
        with:
          branch: automation/php-releases/update

      - name: Create Pull Request
        if: ${{ steps.commit.outputs.commit_sha != '' }}
        uses: paketo-buildpacks/github-config/actions/pull-request/open@main
        with:
          token: ${{ secrets.PAKETO_BOT_GITHUB_TOKEN }}
          title: "Updates PHP releases for each version"
          branch: automation/php-releases/update

  failure:
    name: Alert on Failure
    runs-on: ubuntu-latest
    needs: [get-new-versions]
    if: ${{ always() && needs.get-new-versions.result == 'failure' }}
    steps:
      - name: File Failure Alert Issue
        uses: paketo-buildpacks/github-config/actions/issue/file@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repo: ${{ github.repository }}
          label: "failure:get-specific-php-releases"
          comment_if_exists: true
          issue_title: "Failure: Get Specific PHP Version Releases workflow"
          issue_body: |
            Get Specific PHP Version Releases workflow [failed](https://github.com/${{github.repository}}/actions/runs/${{github.run_id}}).
          comment_body: |
            Another failure occurred: https://github.com/${{github.repository}}/actions/runs/${{github.run_id}}
